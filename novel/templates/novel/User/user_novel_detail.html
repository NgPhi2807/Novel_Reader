{% extends "base_user.html" %}
{% load static %}
{% block extra_css %}
<link rel="stylesheet" href="{% static 'novel/css/truyen-detail.css' %}">
{% endblock %}
{% block content %}
<!-- Breadcrumb Begin -->

<div class="breadcrumb-option">
  <div class="container">
    <div class="row">
      <div class="col-lg-12">
        <div class="breadcrumb__links">
          <a href="{% url 'user_home' %}"><i class="fa fa-home"></i> Home</a>
          <span class="current">{{novel.Name}}</span>
        </div>
      </div>
    </div>
  </div>
</div>
<!-- Breadcrumb End -->

<!-- Truyen Section Begin -->
<section class="truyen-details spad1">
  <div class="container">
    <div class="truyen__details__content">
      <div class="row ">


        <div class="col-lg-3">
          <a class="book-container" href="" target="_blank" rel="noreferrer noopener">
            <div class="book">
              <div class="truyen__details__pic set-bg" {%load static%}
                data-setbg="{% get_media_prefix %}{{novel.ImgUrl}}">
                <div class="comment"><i class="fa fa-comments"></i> 11</div>
                <div class="view"><i class="fa fa-eye"></i> {{ novel.ViewCount }}</div> <!-- Hiển thị lượt xem -->
              </div>
            </div>
          </a>
        </div>

        <div class="col-lg-9 px-5">
          <div class="truyen__details__text">
            <div class="truyen__details__title">
              <h3>{{novel.Name}}</h3>
              <span class="font-20 px-1">Tác giả: {{novel.Author}}</span>
            </div>

            <div class="truyen__details__widget">
              <div class="row">
                <div class="col-lg-12 col-md-12">
                  <ul>
                    <li>
                      <i class="fas fa-book-open px-2"></i>

                      <span class="font-20">Thể loại: </span>
                      <span class="font-20 fw-bold">

                        {% for category in novel.categorynovel_set.all %}
                        {{ category.Category.Name }}{% if not forloop.last %}, {% endif %}
                        {% endfor %}
                      </span>

                    </li>
                    <li>
                      <i class="fas fa-spinner px-2"></i>
                      <span class="font-20">Trạng thái : </span>
                      <span class="font-20 fw-bold">{{novel.State}}</span>

                    </li>
                    <li>
                      <i class="fas fa-file-alt px-2"></i>
                      <span class="font-20 pl-1">Độ dài : </span>
                      <span class="font-20 fw-bold">{{novel.ChapCount}} chương</span>
                    </li>
                  </ul>
                  <div class="truyen__details__rating">
                    <span class="font-20 px-1">Đánh giá : </span>
                    <div class="rating">
                      <a href="#"><i class="fa fa-star"></i></a>
                      <a href="#"><i class="fa fa-star"></i></a>
                      <a href="#"><i class="fa fa-star"></i></a>
                      <a href="#" class="half-star">
                        <i class="fa fa-star"></i>
                        <!-- Sao đầy -->
                        <i class="fa fa-star-half-o"></i>
                        <!-- Nửa sao -->
                      </a>
                    </div>
                    <span class="rating-text"> (5/5) (11 đánh giá) </span>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="truyen_button">
            {% if FirstChapterId %}
            <a href="{% url 'user_chapter_detail' novel.NovelId FirstChapterId %}" class="primary-btn">Đọc truyện</a>
            {% else %}
            {% endif %}
            <a href="#" class="btn primary-btn">Theo dõi</a>

          </div>
        </div>
      </div>
    </div>

    <!-- Truyen Description -->

    <div class="row">
      <div class="col-lg-9 col-md-9">
        <div class="card px-3 py-1">
          <div class="section-title">
            <div class="mt-3">
              <div class="section-title">
                <h4 class="text-black font-24">Truyện có chương mới</h4>
              </div>
              <div class="col-md-12">
                <div class="row1">
                  <table class="table1">
                    <tbody class="chapter-update-list-grid">
                      {% for chapter in chapters %}
                      <tr>
                        <td>
                          <a href="#">
                            <i class="fas fa-book"></i> <!-- Icon Font Awesome -->
                            Chương {{ chapter.Number }}: {{ chapter.Name }}
                          </a>
                        </td>
                      </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
          <!-- Giới thiệu và Danh sách chương -->
          <div class="section-title">
            <a href="#" class="text-black font-24 tab active" data-tab="gioi-thieu">Giới thiệu</a>
            <span class="separator"></span>
            <a href="#" class="text-black font-24 tab" data-tab="danh-sach">Danh sách chương</a>
            <div class="underline"></div>
          </div>
          <div class="tab-content">
            <div id="gioi-thieu" class="content-section active">
              <div class="ml-2">
                {{ novel.Description|safe }}
              </div>
            </div>

            <div id="danh-sach" class="content-section">

              <div class="col-md-12 mb-3">
                <div class="row1">
                  <table class="table ml-2">
                    <tbody id="chapter-list" class="chapter-list-grid">
                      {% for chapter in page_obj %}
                      <tr>
                        <td>
                          <a href="{% url 'user_chapter_detail' novel_id=novel.NovelId chapter_id=chapter.ChapId %}">
                            Chương {{ chapter.Number }}: {{ chapter.Name }}
                          </a>
                        </td>
                      </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                </div>
              </div>
              <div class="pagination mb-3">
                <span class="step-links">
                  {% if page_obj.has_previous %}
                  <a href="#" data-page="1" class="pagination-link">
                    <i class="fas fa-angle-double-left"></i>
                  </a>
                  <a href="#" data-page="{{ page_obj.previous_page_number }}" class="pagination-link">
                    <i class="fas fa-arrow-left"></i>
                  </a>
                  {% endif %}

                  {% for num in page_obj.paginator.page_range %}
                  {% if num == page_obj.number %}
                  <span class="current-page">{{ num }}</span>
                  {% else %}
                  <a href="#" data-page="{{ num }}" class="pagination-link">{{ num }}</a>
                  {% endif %}
                  {% endfor %}

                  {% if page_obj.has_next %}
                  <a href="#" data-page="{{ page_obj.next_page_number }}" class="pagination-link" title="Next">
                    <i class="fas fa-arrow-right"></i>
                  </a>
                  <a href="#" data-page="{{ page_obj.paginator.num_pages }}" class="pagination-link" title="Last">
                    <i class="fas fa-angle-double-right"></i>
                  </a>
                  {% endif %}
                </span>
              </div>
            </div>
            <script>
              function loadChapters(pageNumber) {
                const url = "?page=" + pageNumber;

                fetch(url)
                  .then(response => {
                    if (!response.ok) {
                      throw new Error("Lỗi khi tải dữ liệu từ server: " + response.status);
                    }
                    return response.text();
                  })
                  .then(data => {
                    console.log("Response data:", data);

                    const parser = new DOMParser();
                    const doc = parser.parseFromString(data, 'text/html');

                    const newChapterList = doc.querySelector('#chapter-list');
                    if (newChapterList) {
                      document.getElementById('chapter-list').innerHTML = newChapterList.innerHTML;
                    } else {
                      console.error("Không tìm thấy phần tử #chapter-list trong dữ liệu trả về.");
                    }

                    const newPagination = doc.querySelector('.pagination');
                    if (newPagination) {
                      document.querySelector('.pagination').innerHTML = newPagination.innerHTML;
                    } else {
                      console.error("Không tìm thấy phần tử .pagination trong dữ liệu trả về.");
                    }
                  })
                  .catch(error => console.error('Error:', error));
              }

              document.addEventListener('DOMContentLoaded', function () {
                const paginationContainer = document.querySelector('.pagination');
                if (paginationContainer) {
                  paginationContainer.addEventListener('click', function (event) {
                    if (event.target && event.target.tagName === 'A') {
                      event.preventDefault();

                      const pageNumber = event.target.getAttribute('data-page');
                      if (pageNumber) {
                        loadChapters(pageNumber);
                      } else {
                        console.error("Không tìm thấy thuộc tính data-page trong liên kết phân trang.");
                      }
                    }
                  });
                } else {
                  console.error("Không tìm thấy phần tử .pagination trong DOM.");
                }
              });

            </script>
          </div>
          <!-- Reviews -->
          <div class="truyen__details__review mt-3">
            <div class="section-title">
              <h4 class="text-black font-24">Bình luận</h4>
            </div>
            {% if user.is_authenticated %}
            <form method="POST" class="mt-3">
              {% csrf_token %}
              <textarea name="Content" id="editor" rows="10"></textarea>
              <button type="submit" class="btn btn-success mt-2">Đăng bình luận</button>
            </form>

            {% else %}
            <p>Vui lòng <a href="{% url 'login' %}" class="text-primary fw-bold text-decoration-underline">đăng nhập</a>
              để bình luận.</p>
            {% endif %}

            <style>
              .ck-editor__editable_inline {
                min-height: 160px !important;
              }
            </style>
            {% for comment in comments %}
            <div class="truyen__review__item d-flex align-items-start py-1 mt-3">
              <div class="truyen__review__item__pic me-3">
                <img src="{% static 'novel/img/user/user1.png' %}" alt="User" class="rounded-circle" width="45"
                  height="45" />
              </div>
              <div class="truyen__review__item__text flex-grow-1">
                <h6 class="mb-1 fw-bold">{{ comment.User.username }}</h6>
                <p class="mb-1">{{ comment.Content |safe }}</p>
                <div class="d-flex justify-content-between align-items-center">
                  <small class="text-muted">{{ comment.time_since }}</small>
                  <div class="d-flex gap-3">
                    <a href="#" class="text-muted small"><i class="far fa-thumbs-up me-1"></i>Thích</a>
                  </div>
                </div>
              </div>
            </div>
            {% empty %}
            <p>Chưa có bình luận nào.</p>
            {% endfor %}

            <script>
              ClassicEditor.create(document.querySelector('#editor'), {
                toolbar: [
                  'heading', '|', 'bold', 'italic', 'underline', 'strikethrough', 'link', 'bulletedList', 'numberedList',
                  '|', 'fontSize', 'fontColor', 'fontBackgroundColor', 'emoji', '|',
                  'imageUpload', 'insertTable', 'blockQuote', 'codeBlock', 'mediaEmbed', 'undo', 'redo', 'fullscreen'
                ],
                mediaEmbed: {
                  previewsInData: true
                },
                simpleUpload: {
                  uploadUrl: '/upload/', // Route upload ảnh bạn xử lý bằng Django
                  headers: {
                    'X-CSRFToken': '{{ csrf_token }}'
                  }
                }
              })
                .then(editor => {
                  console.log(editor);
                })
                .catch(error => {
                  console.error(error);
                });
            </script>

          </div>
        </div>
      </div>
      <div class="col-lg-3 col-md-3 pt-1">
        <div class="section-title">
          <h4 class="">Truyện Đọc nhiều</h4>
        </div>
        <div class="hot-novels">
          {% for novel in novels_123 %}
          <div class="hot-novel-item rank-{{ forloop.counter }}">
            <!-- Huy chương chỉ hiển thị cho top 3 -->
            <div class="rank-medal">
              {% if forloop.counter == 1 %}
              <i class="fas fa-medal medal-gold"></i>
              {% elif forloop.counter == 2 %}
              <i class="fas fa-medal medal-silver"></i>
              {% else %}
              <i class="fas fa-medal medal-bronze"></i>
              {% endif %}
            </div>
            
            <div class="novel-info">
              {% if forloop.counter == 1 %}
              <img src="{% get_media_prefix %}{{ novel.ImgUrl }}" alt="{{ novel.Name }}" class="hot-novel-img">
              {% endif %}
            
              <div class="hot-novel-details">
                <a href="{% url 'user_novel_detail' novel.NovelId %}" class="hot-novel-title">
                  {{ novel.Name }}
                </a>
      
                {% if forloop.counter == 1 %}
                <span class="hot-novel-author">
                  <i class="fas fa-user"></i> {{ novel.Author }}
                </span>
                {% endif %}
              </div>
            </div>
          </div>
          {% endfor %}
          {% for novel in novels_4_10 %}
          <div class="hot-novel-item rank-other">
            <div class="rank-number">{{ forloop.counter|add:3 }}</div>
            <div class="novel-info">
              <div class="hot-novel-details">
                <a href="{% url 'user_novel_detail' novel.NovelId %}" class="hot-novel-title">
                  {{ novel.Name }}
                </a>
              </div>
            </div>
          </div>
          {% endfor %}
        </div>
      </div>
      
      
    </div>
  </div>
</section>
<!-- Truyen Section End -->

<style>
/* Tổng quan danh sách truyện */
.hot-novels {
  background: #fff;
  padding: 10px;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
}
/* Tác giả */
.hot-novel-author {
  font-size: 12px;
  color: #777;
  display: flex;
  align-items: center;
  gap: 4px;
  margin-top: 2px;
}

.hot-novel-author i {
  font-size: 12px;
  color: #999;
}
/* Item truyện */
.hot-novel-item {
  display: flex;
  align-items: center;
  padding: 8px 0;
  border-bottom: 1px solid #ddd;
  transition: all 0.2s;
}

.hot-novel-item:last-child {
  border-bottom: none;
}

.hot-novel-item:hover {
  background: #f8f9fa;
}

/* Huy chương */
.rank-medal {
  width: 24px;
  text-align: center;
}

.rank-medal i {
  font-size: 18px;
}

.medal-gold { color: #FFD700; }
.medal-silver { color: #C0C0C0; }
.medal-bronze { color: #CD7F32; }

/* Số thứ tự */
.rank-number {
  font-size: 16px;
  font-weight: bold;
  width: 24px;
  text-align: center;
  color: #555;
}

/* Ảnh của truyện top 1 */
.hot-novel-img {
  width: 50px;
  height: 70px;
  object-fit: cover;
  border-radius: 5px;
  margin-right: 10px;
}

/* Canh chỉnh thông tin truyện */
.novel-info {
  flex: 1;
  display: flex;
  align-items: center;
  gap: 8px;
}

.hot-novel-details {
  flex: 1;
}

/* Tiêu đề truyện */
.hot-novel-title {
  font-size: 14px;
  color: #333;
  font-weight: bold;
  text-decoration: none;
  display: block;
}

.hot-novel-title:hover {
  text-decoration: underline;
  color: inherit;
}

</style>

{% endblock %}