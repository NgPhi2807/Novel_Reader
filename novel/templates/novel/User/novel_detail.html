{% extends "base_user.html" %}
{% load static %}
{% block extra_css %}
<link rel="stylesheet" href="{% static 'novel/css/truyen-detail.css' %}">
{% endblock %}

{% block content %}
<!-- Breadcrumb Begin -->

<div class="breadcrumb-option">
  <div class="container">
    <div class="row">
      <div class="col-lg-12">
        <div class="breadcrumb__links">
          <a href="{% url 'user_home' %}"><i class="fa fa-home"></i> Home</a>
          <span class="current">{{novel.Name}}</span>
        </div>
      </div>
    </div>
  </div>
</div>
<!-- Breadcrumb End -->

<!-- Truyen Section Begin -->
<section class="truyen-details spad1">
  <div class="container">
    <div class="truyen__details__content">
      <div class="row ">

        <div class="col-lg-3">
          <a class="book-container" href="" target="_blank" rel="noreferrer noopener">
            <div class="book">
              <div class="truyen__details__pic set-bg" {%load static%}
                data-setbg="{% get_media_prefix %}{{novel.ImgUrl}}">
                <div class="comment"><i class="fa fa-comments"></i> {{novel.TotalComments}} </div>
                <div class="view"><i class="fa fa-eye"></i> {{ novel.ViewCount }}</div> <!-- Hiển thị lượt xem -->
              </div>
            </div>
          </a>
        </div>

        <div class="col-lg-9 px-5">
          <div class="truyen__details__text">
            <div class="truyen__details__title">
              <h3>{{novel.Name}}</h3>
              <span class="font-20 px-1">Tác giả: {{novel.Author}}</span>
            </div>

            <div class="truyen__details__widget">
              <div class="row">
                <div class="col-lg-12 col-md-12">
                  <ul>
                    <li>
                      <i class="fas fa-book-open px-2"></i>

                      <span class="font-20">Thể loại: </span>
                      <span class="font-20 fw-bold">

                        {% for category in novel.categorynovel_set.all %}
                        {{ category.Category.Name }}{% if not forloop.last %}, {% endif %}
                        {% endfor %}
                      </span>

                    </li>
                    <li>
                      <i class="fas fa-spinner px-2"></i>
                      <span class="font-20">Trạng thái : </span>
                      <span class="font-20 fw-bold">{{novel.State}}</span>

                    </li>
                    <li>
                      <i class="fas fa-file-alt px-2"></i>
                      <span class="font-20 pl-1">Độ dài : </span>
                      <span class="font-20 fw-bold">{{novel.ChapCount}} chương</span>
                    </li>
                  </ul>
                  <div class="truyen__details__rating">
                    <span class="font-20 px-1">Đánh giá : </span>
                    <div class="rating">
                      <a href="#"><i class="fa fa-star"></i></a>
                      <a href="#"><i class="fa fa-star"></i></a>
                      <a href="#"><i class="fa fa-star"></i></a>
                      <a href="#" class="half-star">
                        <i class="fa fa-star"></i>
                        <!-- Sao đầy -->
                        <i class="fa fa-star-half-o"></i>
                        <!-- Nửa sao -->
                      </a>
                    </div>
                    <span class="rating-text"> (5/5) (11 đánh giá) </span>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="truyen_button">
            {% if FirstChapterId %}
            <a href="{% url 'user_chapter_detail' novel.NovelId FirstChapterId %}" class="primary-btn">Đọc truyện</a>
            {% else %}
            {% endif %}
            <a href="#" class="btn primary-btn">Theo dõi</a>

          </div>
        </div>
      </div>
    </div>

    <!-- Truyen Description -->
    <div class="row">
      <div class="col-lg-9 col-md-9">
        <div class="card px-3 py-1">
          <div class="section-title">
            <div class="mt-3">
              <div class="section-title">
                <h4 class="text-black font-24">Truyện có chương mới</h4>
              </div>
              <div class="col-md-12">
                <div class="row1">
                  <table class="table1">
                    <tbody class="chapter-update-list-grid">
                      {% for chapter in chapters %}
                      <tr>
                        <td>
                          <a href="#">
                            <i class="fas fa-book"></i> <!-- Icon Font Awesome -->
                            Chương {{ chapter.Number }}: {{ chapter.Name }}
                          </a>
                        </td>
                      </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
          <!-- Giới thiệu và Danh sách chương -->
          <div class="section-title">
            <a href="#" class="text-black font-24 tab active" data-tab="gioi-thieu">Giới thiệu</a>
            <span class="separator"></span>
            <a href="#" class="text-black font-24 tab" data-tab="danh-sach">Danh sách chương</a>
            <div class="underline"></div>
          </div>
          <div class="tab-content">
            <div id="gioi-thieu" class="content-section active">
              <div class="ml-2">
                {{ novel.Description|safe }}
              </div>
            </div>

            <div id="danh-sach" class="content-section">

              <div class="col-md-12 mb-3">
                <div class="row1">
                  <table class="table ml-2">
                    <tbody id="chapter-list" class="chapter-list-grid">
                      {% for chapter in page_obj %}
                      <tr>
                        <td>
                          <a href="{% url 'user_chapter_detail' novel_id=novel.NovelId chapter_id=chapter.ChapId %}">
                            Chương {{ chapter.Number }}: {{ chapter.Name }}
                          </a>
                        </td>
                      </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                </div>
              </div>
              <div class="pagination mb-3">
                <span class="step-links">
                  {% if page_obj.has_previous %}
                  <a href="#" data-page="1" class="pagination-link">
                    <i class="fas fa-angle-double-left"></i>
                  </a>
                  <a href="#" data-page="{{ page_obj.previous_page_number }}" class="pagination-link">
                    <i class="fas fa-arrow-left"></i>
                  </a>
                  {% endif %}

                  {% for num in page_obj.paginator.page_range %}
                  {% if num == page_obj.number %}
                  <span class="current-page">{{ num }}</span>
                  {% else %}
                  <a href="#" data-page="{{ num }}" class="pagination-link">{{ num }}</a>
                  {% endif %}
                  {% endfor %}

                  {% if page_obj.has_next %}
                  <a href="#" data-page="{{ page_obj.next_page_number }}" class="pagination-link" title="Next">
                    <i class="fas fa-arrow-right"></i>
                  </a>
                  <a href="#" data-page="{{ page_obj.paginator.num_pages }}" class="pagination-link" title="Last">
                    <i class="fas fa-angle-double-right"></i>
                  </a>
                  {% endif %}
                </span>
              </div>
            </div>
            <script>
              function loadChapters(pageNumber) {
                const url = "?page=" + pageNumber;

                fetch(url)
                  .then(response => {
                    if (!response.ok) {
                      throw new Error("Lỗi khi tải dữ liệu từ server: " + response.status);
                    }
                    return response.text();
                  })
                  .then(data => {
                    console.log("Response data:", data);

                    const parser = new DOMParser();
                    const doc = parser.parseFromString(data, 'text/html');

                    const newChapterList = doc.querySelector('#chapter-list');
                    if (newChapterList) {
                      document.getElementById('chapter-list').innerHTML = newChapterList.innerHTML;
                    } else {
                      console.error("Không tìm thấy phần tử #chapter-list trong dữ liệu trả về.");
                    }

                    const newPagination = doc.querySelector('.pagination');
                    if (newPagination) {
                      document.querySelector('.pagination').innerHTML = newPagination.innerHTML;
                    } else {
                      console.error("Không tìm thấy phần tử .pagination trong dữ liệu trả về.");
                    }
                  })
                  .catch(error => console.error('Error:', error));
              }

              document.addEventListener('DOMContentLoaded', function () {
                const paginationContainer = document.querySelector('.pagination');
                if (paginationContainer) {
                  paginationContainer.addEventListener('click', function (event) {
                    if (event.target && event.target.tagName === 'A') {
                      event.preventDefault();

                      const pageNumber = event.target.getAttribute('data-page');
                      if (pageNumber) {
                        loadChapters(pageNumber);
                      } else {
                        console.error("Không tìm thấy thuộc tính data-page trong liên kết phân trang.");
                      }
                    }
                  });
                } else {
                  console.error("Không tìm thấy phần tử .pagination trong DOM.");
                }
              });

              function toggleReplyForm(commentId, parentId, replyToUsername = '') {
                const formId = `reply-form-${commentId}`;
                const popup = document.getElementById(formId);

                // Hide all other popups first
                document.querySelectorAll('.reply-popup').forEach(p => {
                  if (p.id !== formId) {
                    p.style.display = 'none';
                  }
                });

                // Toggle current popup
                if (popup) {
                  if (popup.style.display === 'none' || popup.style.display === '') {
                    popup.style.display = 'block';
                    if (!popup.querySelector('form')) {
                      const formHtml = `
                        <form method="POST">
                          {% csrf_token %}
                          <textarea name="Content" class="form-control1" rows="1" 
                            placeholder="Viết phản hồi...">${replyToUsername ? '@' + replyToUsername + ' ' : ''}</textarea>
                          <input type="hidden" name="parent_comment_id" value="${parentId}">
                          <input type="hidden" name="replied_to_user" value="${replyToUsername}">
                          <div class="reply-buttons">
                            <button type="submit" class="btn btn-light btn-sm">Gửi</button>
                            <button type="button" class="btn btn-light btn-sm" 
                              onclick="document.getElementById('${formId}').style.display='none'">Hủy</button>
                          </div>
                        </form>
                      `;
                      popup.innerHTML = formHtml;

                      const textarea = popup.querySelector('textarea');
                      textarea.addEventListener('input', function () {
                        this.style.height = 'auto';
                        this.style.height = Math.min(this.scrollHeight, 150) + 'px';
                      });
                    }
                  } else {
                    popup.style.display = 'none';
                  }
                }
              }

              function toggleReplies(replyContainerId) {
                const container = document.getElementById(replyContainerId);
                if (container) {
                  container.style.display = container.style.display === 'none' ? 'block' : 'none';
                }
              }
            </script>
          </div>
          <div class="truyen__details__review mt-3">
            <div class="section-title d-flex justify-content-between align-items-center">
              <h4 class="text-black font-24 mb-0">Bình luận</h4>
              <button id="toggleComments" class="btn btn-light btn-sm">
                <i class="fas fa-chevron-up"></i>
              </button>
            </div>

            <div id="commentSection">
              {% if user.is_authenticated %}
              <form method="POST" class="mt-3 comment-form">
                {% csrf_token %}
                <div class="d-flex gap-2">
                  <img src="{% static 'novel/img/user/user1.png' %}" alt="User"  width="40"
                    height="40" />
                  <div class="flex-grow-1">
                    <textarea name="Content" id="editor" class="form-control" placeholder="Viết bình luận..."
                      rows="1"></textarea>
                    <button type="submit" class="btn btn-primary mt-2 float-end">Đăng bình luận</button>
                  </div>
                </div>
              </form>
              <style>
                .gap-2 {
                  gap: 20px;
                }
              </style>
              {% else %}
              <p>Vui lòng <a href="{% url 'login' %}" class="text-primary fw-bold text-decoration-underline">đăng
                  nhập</a> để bình luận.</p>
              {% endif %}

              <div class="comments-container mt-4">
                {% for comment in comments %}
                {% if not comment.parent_comment %}
                <div class="comment-thread">
                  <div class="comment-main rounded">
                    <div class="d-flex gap-2">
                      <img src="{% static 'novel/img/user/user1.png' %}" alt="User"  width="40" height="40" />
                      <div class="flex-grow-1">
                        <div class="comment-content bg-light p-3 rounded">
                          <h6 class="mb-1 fw-bold text-primary">{{ comment.User.username }}</h6>
                          <p class="mb-1">{{ comment.Content|safe }}</p>
                        </div>
                        <div class="comment-actions mt-1">
                          <small class="text-muted">{{ comment.time_since }}</small>
                          {% if user.is_authenticated %}
                          <div class="reply-wrapper">
                            <button class="btn btn-link btn-sm p-0 ms-2 reply-trigger" 
                              onclick="toggleReplyForm('{{ comment.CommentId }}', '{{ comment.CommentId }}', '{{ comment.User.username }}')">
                              Trả lời
                            </button>
                            <div id="reply-form-{{ comment.CommentId }}" class="reply-popup"></div>
                          </div>
                          {% endif %}
                          {% if comment.replies.count > 0 %}
                          <span class="reply-count ms-2" onclick="toggleReplies('replies-{{ comment.CommentId }}')">
                            <i class="fas fa-comment-dots"></i>
                            <span>{{ comment.replies.count }} phản hồi</span>
                          </span>
                          {% endif %}
                        </div>

                        <!-- Container chứa các replies -->
                        <div id="replies-{{ comment.CommentId }}" class="replies-container mt-2" style="display: none;">
                          {% for reply in comment.replies.all %}
                          <div class="reply-thread">
                            <div class="d-flex gap-2 mt-2">
                              <img src="{% static 'novel/img/user/user1.png' %}" alt="User"  width="32" height="32" />
                              <div class="flex-grow-1">
                                <div class="comment-content bg-light p-2 rounded">
                                  <h6 class="mb-1 fw-bold">{{ reply.User.username }}</h6>
                                  <p class="mb-1">
                                    {% if reply.replied_to_user %}
                                    <span class="replied-to">@{{ reply.replied_to_user }}</span>
                                    {% endif %}
                                    {{ reply.Content|safe }}</span>
                                  </p>
                                </div>
                                <div class="comment-actions mt-1">
                                  <small class="text-muted">{{ reply.time_since }}</small>
                                  {% if user.is_authenticated %}
                                  <div class="reply-wrapper">
                                    <button class="btn btn-link btn-sm p-0 ms-2 reply-trigger" 
                                      onclick="toggleReplyForm('{{ reply.CommentId }}', '{{ comment.CommentId }}', '{{ reply.User.username }}')">
                                      Trả lời
                                    </button>
                                    <div id="reply-form-{{ reply.CommentId }}" class="reply-popup"></div>
                                  </div>
                                  {% endif %}
                                </div>
                              </div>
                            </div>
                          </div>
                          {% endfor %}
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                {% endif %}
                {% empty %}
                <p>Chưa có bình luận nào.</p>
                {% endfor %}
              </div>
            </div>
          </div>

<style>
  /* Facebook-style comment section */
  .comment-main {
    background-color: transparent;
    border: none;
    margin-bottom: 12px;
  }

  .comment-content {
    background-color: #f0f2f5 !important;
    border-radius: 5px !important;
    box-shadow: none !important;
    display:flex;
    flex-direction: column;
    gap:5px;
  }

  .comment-actions {
    font-size: 0.8rem;
    padding-left: 12px;
    display: flex;
    gap: 15px;
    flex-direction: row;
    align-items: center;
  }

  .comment-actions button,
  .reply-count {
    color: #65676B;
    font-weight: 600;
    text-decoration: none;
  }

  .comment-actions button:hover,
  .reply-count:hover {
    text-decoration: underline;
  }

  .replies-container {
    
    padding-left: 0;
    border-left: none;
  }

  .comment-form {
    margin-bottom: 20px;
  }

  .comment-form textarea,
  .reply-form textarea {
    border-radius: 20px;
    padding: 10px 15px;
    resize: none;
    background-color: #f0f2f5;
    border: none;
    box-shadow: none;
  }

  .comment-form textarea:focus,
  .reply-form textarea:focus {
    box-shadow: none;
    border: none;
    background-color: #f0f2f5;
  }

  .comment-thread {
    margin-bottom: 16px;
  }

  .reply-item {
    margin-bottom: 8px;
  }

  .reply-form {
    margin-left: 52px;
    margin-top: 8px !important;
  }

  /* User profile images */
  .rounded-circle {
    border: 1px solid #ddd;
  }

  /* Comment button styling */
  .comment-form button,
  .reply-form button {
    background-color: #1877F2;
    border: none;
    border-radius: 6px;
    font-weight: 600;
    font-size: 0.85rem;
    padding: 5px 12px;
  }

  .comment-form button:hover,
  .reply-form button:hover {
    background-color: #166fe5;
  }

  /* Toggle comments button */
  #toggleComments {
    border: none;
    background-color: transparent;
    color: #65676B;
  }

  #toggleComments:hover {
    background-color: #f0f2f5;
  }

  /* Username styling */
  .comment-content h6 {
    font-size: 1.2rem;
    margin-bottom: 2px !important;
  }

  /* Comment text styling */
  .comment-content p {
    font-size: 0.9rem;
    margin-bottom: 0 !important;
  }

  /* Gap between user image and comment */
  .gap-2 {
    gap: 12px !important;
  }

  /* Section title styling */
  .section-title h4 {
    font-weight: 600;
    color: #050505;
  }

  /* Timestamp styling */
  .text-muted {
    color: #65676B !important;
  }

  .replied-to {
    color: #1877F2 !important;
    font-weight: 800 !important;
    margin-right: 4px;
  }
  .form-control1 {
    display: block;
    width: 100%;
    height: calc(1.5em + .75rem + 20px);
    padding: .375rem .75rem;
    font-size: 1rem;
    font-weight: 400;
    line-height: 1.5;
    color: #495057;
    background-color: #fff;
    background-clip: padding-box;
    border: 1px solid #ced4da;
    border-radius: .25rem;
    transition: border-color .15s ease-in-out, box-shadow .15s ease-in-out;
    color: #187ff2;
  }

  /* Add these new styles */
  .reply-wrapper {
    position: relative;
    display: inline-block;
  }

  .reply-popup {
    position: absolute;
    bottom: 100%;
    left: 0;
    background: white;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    padding: 8px;
    margin-bottom: 4px;
    display: none;
    width: 500px;
    z-index: 1000;
  }

  .reply-form {
    margin: 0 !important;
    display: flex;
    align-items: flex-start;
    gap: 8px;
  }

  .reply-form form {
    flex: 1;
  }

  .reply-form textarea {
    min-height: 36px;
    padding: 8px 12px;
    width: 100%;
    margin-bottom: 8px;
  }

  .reply-buttons {
    display: flex;
    justify-content: flex-end;
    gap: 8px;
    margin-top:10px;
  }

  .reply-trigger {
    cursor: pointer;
  }

  .reply-trigger:hover + .reply-popup,
  .reply-popup:hover {
    display: block;
  }
</style>
          <script>
            ClassicEditor.create(document.querySelector('#editor'), {
              toolbar: [
                'heading', '|', 'bold', 'italic', 'underline', 'strikethrough', 'link', 'bulletedList', 'numberedList',
                '|', 'fontSize', 'fontColor', 'fontBackgroundColor', 'emoji', '|',
                'imageUpload', 'insertTable', 'blockQuote', 'codeBlock', 'mediaEmbed', 'undo', 'redo', 'fullscreen'
              ],
              mediaEmbed: {
                previewsInData: true
              },
              simpleUpload: {
                uploadUrl: '/upload/', // Route upload ảnh bạn xử lý bằng Django
                headers: {
                  'X-CSRFToken': '{{ csrf_token }}'
                }
              }
            })
              .then(editor => {
                console.log(editor);
              })
              .catch(error => {
                console.error(error);
              });
          </script>


        </div>
      </div>
      <div class="col-lg-3 col-md-3 pt-1">
        <div class="section-title">
          <h4 class="">Truyện Đọc nhiều</h4>
        </div>
        <div class="hot-novels">
          {% for novel in novels_123 %}
          <div class="hot-novel-item rank-{{ forloop.counter }}">
            <!-- Huy chương chỉ hiển thị cho top 3 -->
            <div class="rank-medal">
              {% if forloop.counter == 1 %}
              <i class="fas fa-medal medal-gold"></i>
              {% elif forloop.counter == 2 %}
              <i class="fas fa-medal medal-silver"></i>
              {% else %}
              <i class="fas fa-medal medal-bronze"></i>
              {% endif %}
            </div>

            <div class="novel-info">
              {% if forloop.counter == 1 %}
              <img src="{% get_media_prefix %}{{ novel.ImgUrl }}" alt="{{ novel.Name }}" class="hot-novel-img">
              {% endif %}

              <div class="hot-novel-details">
                <a href="{% url 'user_novel_detail' novel.NovelId %}" class="hot-novel-title">
                  {{ novel.Name }}
                </a>

                {% if forloop.counter == 1 %}
                <span class="hot-novel-author">
                  <i class="fas fa-user"></i> {{ novel.Author }}
                </span>
                {% endif %}
              </div>
            </div>
          </div>
          {% endfor %}
          {% for novel in novels_4_10 %}
          <div class="hot-novel-item rank-other">
            <div class="rank-number">{{ forloop.counter|add:3 }}</div>
            <div class="novel-info">
              <div class="hot-novel-details">
                <a href="{% url 'user_novel_detail' novel.NovelId %}" class="hot-novel-title">
                  {{ novel.Name }}
                </a>
              </div>
            </div>
          </div>
          {% endfor %}
        </div>
      </div>


    </div>
  </div>
</section>
<!-- Truyen Section End -->

<style>
  .hot-novels {
    background: #fff;
    padding: 10px;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
  }

  .hot-novel-author {
    font-size: 12px;
    color: #777;
    display: flex;
    align-items: center;
    gap: 4px;
    margin-top: 2px;
  }

  .hot-novel-author i {
    font-size: 12px;
    color: #999;
  }

  /* Item truyện */
  .hot-novel-item {
    display: flex;
    align-items: center;
    padding: 8px 0;
    border-bottom: 1px solid #ddd;
    transition: all 0.2s;
  }

  .hot-novel-item:last-child {
    border-bottom: none;
  }

  .hot-novel-item:hover {
    background: #f8f9fa;
  }

  .rank-medal {
    width: 24px;
    text-align: center;
  }

  .rank-medal i {
    font-size: 18px;
  }

  .medal-gold {
    color: #FFD700;
  }

  .medal-silver {
    color: #C0C0C0;
  }

  .medal-bronze {
    color: #CD7F32;
  }

  /* Số thứ tự */
  .rank-number {
    font-size: 16px;
    font-weight: bold;
    width: 24px;
    text-align: center;
    color: #555;
  }

  /* Ảnh của truyện top 1 */
  .hot-novel-img {
    width: 50px;
    height: 70px;
    object-fit: cover;
    border-radius: 5px;
    margin-right: 10px;
  }

  /* Canh chỉnh thông tin truyện */
  .novel-info {
    flex: 1;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .hot-novel-details {
    flex: 1;
  }

  /* Tiêu đề truyện */
  .hot-novel-title {
    font-size: 14px;
    color: #333;
    font-weight: bold;
    text-decoration: none;
    display: block;
  }

  .hot-novel-title:hover {
    text-decoration: underline;
    color: inherit;
  }
</style>

{% endblock %}